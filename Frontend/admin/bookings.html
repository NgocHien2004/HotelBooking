<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quản lý đặt phòng - Hotel Booking Admin</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <link href="../assets/css/style.css" rel="stylesheet" />
    <link href="../assets/css/admin.css" rel="stylesheet" />
  </head>
  <body>
    <!-- Header -->
    <header class="header">
      <nav class="navbar">
        <div class="nav-container">
          <div class="nav-logo">
            <a href="../index.html">
              <i class="fas fa-hotel"></i>
              <span>Hotel Booking Admin</span>
            </a>
          </div>

          <div class="nav-menu" id="nav-menu">
            <div class="nav-user" id="nav-user">
              <div class="user-dropdown">
                <button class="user-btn" id="user-btn">
                  <i class="fas fa-user"></i>
                  <span id="user-name">Admin</span>
                  <i class="fas fa-chevron-down"></i>
                </button>
                <div class="dropdown-menu" id="dropdown-menu">
                  <a href="../profile.html" class="dropdown-item"> <i class="fas fa-user"></i> Thông tin cá nhân </a>
                  <a href="../index.html" class="dropdown-item"> <i class="fas fa-home"></i> Trang chủ </a>
                  <hr />
                  <button class="dropdown-item logout-btn" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Đăng xuất</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <!-- Admin Layout -->
    <div class="admin-layout">
      <!-- Sidebar -->
      <aside class="admin-sidebar">
        <ul class="sidebar-menu">
          <li class="sidebar-item">
            <a href="dashboard.html" class="sidebar-link">
              <i class="fas fa-tachometer-alt"></i>
              <span>Dashboard</span>
            </a>
          </li>
          <li class="sidebar-item">
            <a href="hotels.html" class="sidebar-link">
              <i class="fas fa-hotel"></i>
              <span>Quản lý khách sạn</span>
            </a>
          </li>
          <li class="sidebar-item">
            <a href="rooms.html" class="sidebar-link">
              <i class="fas fa-bed"></i>
              <span>Quản lý phòng</span>
            </a>
          </li>
          <li class="sidebar-item">
            <a href="bookings.html" class="sidebar-link active">
              <i class="fas fa-calendar-check"></i>
              <span>Quản lý đặt phòng</span>
            </a>
          </li>
          <li class="sidebar-item">
            <a href="users.html" class="sidebar-link">
              <i class="fas fa-users"></i>
              <span>Quản lý người dùng</span>
            </a>
          </li>
          <li class="sidebar-item">
            <a href="reviews.html" class="sidebar-link">
              <i class="fas fa-star"></i>
              <span>Quản lý đánh giá</span>
            </a>
          </li>
        </ul>
      </aside>

      <!-- Main Content -->
      <main class="admin-content">
        <div class="admin-header">
          <h1>Quản lý đặt phòng</h1>
          <p>Theo dõi và quản lý tất cả đặt phòng</p>
        </div>

        <!-- Stats Cards -->
        <div class="admin-cards">
          <div class="admin-card">
            <div class="admin-card-header">
              <h3 class="admin-card-title">Chờ xác nhận</h3>
              <div class="admin-card-icon">
                <i class="fas fa-clock"></i>
              </div>
            </div>
            <div class="admin-card-value" id="pending-bookings">0</div>
          </div>

          <div class="admin-card">
            <div class="admin-card-header">
              <h3 class="admin-card-title">Đã xác nhận</h3>
              <div class="admin-card-icon">
                <i class="fas fa-check-circle"></i>
              </div>
            </div>
            <div class="admin-card-value" id="confirmed-bookings">0</div>
          </div>

          <div class="admin-card">
            <div class="admin-card-header">
              <h3 class="admin-card-title">Hoàn thành</h3>
              <div class="admin-card-icon">
                <i class="fas fa-calendar-check"></i>
              </div>
            </div>
            <div class="admin-card-value" id="completed-bookings">0</div>
          </div>

          <div class="admin-card">
            <div class="admin-card-header">
              <h3 class="admin-card-title">Đã hủy</h3>
              <div class="admin-card-icon">
                <i class="fas fa-times-circle"></i>
              </div>
            </div>
            <div class="admin-card-value" id="cancelled-bookings">0</div>
          </div>
        </div>

        <!-- Filters -->
        <div class="admin-table-container">
          <div class="admin-table-header">
            <h3 class="admin-table-title">Danh sách đặt phòng</h3>
            <div class="admin-table-actions">
              <select id="status-filter" class="search-input">
                <option value="">Tất cả trạng thái</option>
                <option value="Pending">Chờ xác nhận</option>
                <option value="Confirmed">Đã xác nhận</option>
                <option value="Completed">Hoàn thành</option>
                <option value="Cancelled">Đã hủy</option>
              </select>
              <input type="date" id="date-filter" class="search-input" title="Lọc theo ngày đặt" />
              <input type="text" class="search-input" id="search-bookings" placeholder="Tìm kiếm theo tên khách..." />
              <button class="btn btn-primary" onclick="AdminBookings.exportBookings()">
                <i class="fas fa-download"></i>
                Xuất Excel
              </button>
            </div>
          </div>

          <div class="loading" id="bookings-loading">
            <div class="spinner"></div>
            <p>Đang tải dữ liệu...</p>
          </div>

          <table class="admin-table" id="bookings-table" style="display: none">
            <thead>
              <tr>
                <th>Mã đặt phòng</th>
                <th>Khách hàng</th>
                <th>Khách sạn</th>
                <th>Phòng</th>
                <th>Ngày nhận</th>
                <th>Ngày trả</th>
                <th>Tổng tiền</th>
                <th>Trạng thái</th>
                <th>Thao tác</th>
              </tr>
            </thead>
            <tbody id="bookings-table-body">
              <!-- Bookings will be loaded here -->
            </tbody>
          </table>

          <!-- Pagination -->
          <div class="pagination" id="bookings-pagination">
            <!-- Pagination will be loaded here -->
          </div>
        </div>
      </main>
    </div>

    <!-- Booking Detail Modal -->
    <div class="modal admin-modal" id="booking-detail-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Chi tiết đặt phòng</h3>
          <button class="modal-close" onclick="Utils.hideModal('#booking-detail-modal')">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body" id="booking-detail-content">
          <!-- Booking detail will be loaded here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="Utils.hideModal('#booking-detail-modal')">Đóng</button>
        </div>
      </div>
    </div>

    <!-- Update Status Modal -->
    <div class="modal" id="update-status-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Cập nhật trạng thái</h3>
          <button class="modal-close" onclick="Utils.hideModal('#update-status-modal')">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <form id="update-status-form">
            <div class="form-group">
              <label for="new-status">Trạng thái mới:</label>
              <select id="new-status" class="form-input" required>
                <option value="Pending">Chờ xác nhận</option>
                <option value="Confirmed">Đã xác nhận</option>
                <option value="Completed">Hoàn thành</option>
                <option value="Cancelled">Đã hủy</option>
              </select>
            </div>
            <div class="form-group">
              <label for="status-note">Ghi chú (tùy chọn):</label>
              <textarea id="status-note" class="form-input" rows="3" placeholder="Thêm ghi chú về việc thay đổi trạng thái..."></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="Utils.hideModal('#update-status-modal')">Hủy</button>
          <button type="submit" form="update-status-form" class="btn btn-primary" id="update-status-btn">
            <i class="fas fa-save"></i>
            Cập nhật
          </button>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="../assets/js/utils.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/booking.js"></script>
    <script src="../assets/js/admin.js"></script>
    <script src="../assets/js/app.js"></script>

    <script>
      // Initialize Admin Bookings
      class AdminBookings {
        constructor() {
          this.bookings = [];
          this.currentPage = 1;
          this.totalPages = 1;
          this.selectedBookingId = null;
          this.stats = {
            pending: 0,
            confirmed: 0,
            completed: 0,
            cancelled: 0,
          };

          this.init();
        }

        async init() {
          await this.loadBookings();
          this.bindEvents();
        }

        async loadBookings() {
          try {
            Utils.show("#bookings-loading");
            Utils.hide("#bookings-table");

            // Mock data - replace with actual API call
            this.bookings = [
              {
                maDatPhong: 1,
                hoTenKhach: "Nguyễn Văn A",
                emailKhach: "nguyenvana@email.com",
                tenKhachSan: "Hotel ABC",
                soPhong: "101",
                tenLoaiPhong: "Standard Room",
                ngayNhanPhong: "2024-12-25",
                ngayTraPhong: "2024-12-27",
                soNgayO: 2,
                tongTien: 1000000,
                trangThai: "Pending",
                ngayDat: "2024-12-20T10:30:00",
              },
              {
                maDatPhong: 2,
                hoTenKhach: "Trần Thị B",
                emailKhach: "tranthib@email.com",
                tenKhachSan: "Hotel XYZ",
                soPhong: "201",
                tenLoaiPhong: "Deluxe Room",
                ngayNhanPhong: "2024-12-26",
                ngayTraPhong: "2024-12-28",
                soNgayO: 2,
                tongTien: 1600000,
                trangThai: "Confirmed",
                ngayDat: "2024-12-21T14:15:00",
              },
              {
                maDatPhong: 3,
                hoTenKhach: "Lê Văn C",
                emailKhach: "levanc@email.com",
                tenKhachSan: "Hotel ABC",
                soPhong: "102",
                tenLoaiPhong: "Standard Room",
                ngayNhanPhong: "2024-12-22",
                ngayTraPhong: "2024-12-24",
                soNgayO: 2,
                tongTien: 1000000,
                trangThai: "Completed",
                ngayDat: "2024-12-18T09:20:00",
              },
            ];

            this.calculateStats();
            this.renderBookingsTable();
            this.updateStatsCards();
          } catch (error) {
            Utils.handleApiError(error);
          } finally {
            Utils.hide("#bookings-loading");
            Utils.show("#bookings-table");
          }
        }

        calculateStats() {
          this.stats = {
            pending: this.bookings.filter((b) => b.trangThai === "Pending").length,
            confirmed: this.bookings.filter((b) => b.trangThai === "Confirmed").length,
            completed: this.bookings.filter((b) => b.trangThai === "Completed").length,
            cancelled: this.bookings.filter((b) => b.trangThai === "Cancelled").length,
          };
        }

        updateStatsCards() {
          Utils.$("#pending-bookings").textContent = this.stats.pending;
          Utils.$("#confirmed-bookings").textContent = this.stats.confirmed;
          Utils.$("#completed-bookings").textContent = this.stats.completed;
          Utils.$("#cancelled-bookings").textContent = this.stats.cancelled;
        }

        renderBookingsTable() {
          const tbody = Utils.$("#bookings-table-body");
          if (!tbody) return;

          if (this.bookings.length === 0) {
            tbody.innerHTML = `
                        <tr>
                            <td colspan="9" class="text-center">
                                Chưa có đặt phòng nào
                            </td>
                        </tr>
                    `;
            return;
          }

          tbody.innerHTML = this.bookings
            .map(
              (booking) => `
                    <tr>
                        <td>#${booking.maDatPhong}</td>
                        <td>
                            <div>
                                <strong>${booking.hoTenKhach}</strong>
                                <br>
                                <small class="text-secondary">${booking.emailKhach}</small>
                            </div>
                        </td>
                        <td>${booking.tenKhachSan}</td>
                        <td>${booking.soPhong} - ${booking.tenLoaiPhong}</td>
                        <td>${Utils.formatDate(booking.ngayNhanPhong)}</td>
                        <td>${Utils.formatDate(booking.ngayTraPhong)}</td>
                        <td>${Utils.formatCurrency(booking.tongTien)}</td>
                        <td>
                            <span class="status-badge ${booking.trangThai.toLowerCase()}">
                                ${this.getStatusText(booking.trangThai)}
                            </span>
                        </td>
                        <td class="actions">
                            <button class="btn btn-sm btn-outline" onclick="AdminBookings.viewBookingDetail(${
                              booking.maDatPhong
                            })" title="Xem chi tiết">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-primary" onclick="AdminBookings.updateStatus(${
                              booking.maDatPhong
                            })" title="Cập nhật trạng thái">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    </tr>
                `
            )
            .join("");
        }

        getStatusText(status) {
          const statusMap = {
            Pending: "Chờ xác nhận",
            Confirmed: "Đã xác nhận",
            Completed: "Hoàn thành",
            Cancelled: "Đã hủy",
          };
          return statusMap[status] || status;
        }

        bindEvents() {
          // Filter events
          const statusFilter = Utils.$("#status-filter");
          const dateFilter = Utils.$("#date-filter");
          const searchInput = Utils.$("#search-bookings");

          if (statusFilter) {
            statusFilter.addEventListener("change", () => {
              this.applyFilters();
            });
          }

          if (dateFilter) {
            dateFilter.addEventListener("change", () => {
              this.applyFilters();
            });
          }

          if (searchInput) {
            searchInput.addEventListener(
              "input",
              Utils.debounce((e) => {
                this.applyFilters();
              }, 300)
            );
          }

          // Update status form
          const updateStatusForm = Utils.$("#update-status-form");
          if (updateStatusForm) {
            updateStatusForm.addEventListener("submit", (e) => {
              e.preventDefault();
              this.saveStatusUpdate();
            });
          }
        }

        applyFilters() {
          const statusFilter = Utils.$("#status-filter").value;
          const dateFilter = Utils.$("#date-filter").value;
          const searchTerm = Utils.$("#search-bookings").value.toLowerCase();

          let filteredBookings = [...this.bookings];

          // Filter by status
          if (statusFilter) {
            filteredBookings = filteredBookings.filter((booking) => booking.trangThai === statusFilter);
          }

          // Filter by date
          if (dateFilter) {
            filteredBookings = filteredBookings.filter((booking) => booking.ngayDat.startsWith(dateFilter));
          }

          // Filter by search term
          if (searchTerm) {
            filteredBookings = filteredBookings.filter(
              (booking) =>
                booking.hoTenKhach.toLowerCase().includes(searchTerm) ||
                booking.emailKhach.toLowerCase().includes(searchTerm) ||
                booking.tenKhachSan.toLowerCase().includes(searchTerm)
            );
          }

          this.renderFilteredBookingsTable(filteredBookings);
        }

        renderFilteredBookingsTable(bookings) {
          const tbody = Utils.$("#bookings-table-body");
          if (!tbody) return;

          if (bookings.length === 0) {
            tbody.innerHTML = `
                        <tr>
                            <td colspan="9" class="text-center">
                                Không tìm thấy đặt phòng nào phù hợp
                            </td>
                        </tr>
                    `;
            return;
          }

          tbody.innerHTML = bookings
            .map(
              (booking) => `
                    <tr>
                        <td>#${booking.maDatPhong}</td>
                        <td>
                            <div>
                                <strong>${booking.hoTenKhach}</strong>
                                <br>
                                <small class="text-secondary">${booking.emailKhach}</small>
                            </div>
                        </td>
                        <td>${booking.tenKhachSan}</td>
                        <td>${booking.soPhong} - ${booking.tenLoaiPhong}</td>
                        <td>${Utils.formatDate(booking.ngayNhanPhong)}</td>
                        <td>${Utils.formatDate(booking.ngayTraPhong)}</td>
                        <td>${Utils.formatCurrency(booking.tongTien)}</td>
                        <td>
                            <span class="status-badge ${booking.trangThai.toLowerCase()}">
                                ${this.getStatusText(booking.trangThai)}
                            </span>
                        </td>
                        <td class="actions">
                            <button class="btn btn-sm btn-outline" onclick="AdminBookings.viewBookingDetail(${
                              booking.maDatPhong
                            })" title="Xem chi tiết">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-primary" onclick="AdminBookings.updateStatus(${
                              booking.maDatPhong
                            })" title="Cập nhật trạng thái">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    </tr>
                `
            )
            .join("");
        }

        static async viewBookingDetail(bookingId) {
          try {
            const booking = window.adminBookings.bookings.find((b) => b.maDatPhong === bookingId);
            if (!booking) {
              Utils.showError("Không tìm thấy thông tin đặt phòng");
              return;
            }

            const detailContent = Utils.$("#booking-detail-content");
            detailContent.innerHTML = `
                        <div class="booking-detail-grid">
                            <div class="detail-section">
                                <h4>Thông tin đặt phòng</h4>
                                <div class="detail-row">
                                    <span>Mã đặt phòng:</span>
                                    <span><strong>#${booking.maDatPhong}</strong></span>
                                </div>
                                <div class="detail-row">
                                    <span>Ngày đặt:</span>
                                    <span>${Utils.formatDateTime(booking.ngayDat)}</span>
                                </div>
                                <div class="detail-row">
                                    <span>Trạng thái:</span>
                                    <span class="status-badge ${booking.trangThai.toLowerCase()}">
                                        ${window.adminBookings.getStatusText(booking.trangThai)}
                                    </span>
                                </div>
                            </div>

                            <div class="detail-section">
                                <h4>Thông tin khách hàng</h4>
                                <div class="detail-row">
                                    <span>Họ tên:</span>
                                    <span>${booking.hoTenKhach}</span>
                                </div>
                                <div class="detail-row">
                                    <span>Email:</span>
                                    <span>${booking.emailKhach}</span>
                                </div>
                            </div>

                            <div class="detail-section">
                                <h4>Thông tin phòng</h4>
                                <div class="detail-row">
                                    <span>Khách sạn:</span>
                                    <span>${booking.tenKhachSan}</span>
                                </div>
                                <div class="detail-row">
                                    <span>Phòng:</span>
                                    <span>${booking.soPhong} - ${booking.tenLoaiPhong}</span>
                                </div>
                                <div class="detail-row">
                                    <span>Ngày nhận phòng:</span>
                                    <span>${Utils.formatDate(booking.ngayNhanPhong)}</span>
                                </div>
                                <div class="detail-row">
                                    <span>Ngày trả phòng:</span>
                                    <span>${Utils.formatDate(booking.ngayTraPhong)}</span>
                                </div>
                                <div class="detail-row">
                                    <span>Số đêm:</span>
                                    <span>${booking.soNgayO} đêm</span>
                                </div>
                            </div>

                            <div class="detail-section">
                                <h4>Thông tin thanh toán</h4>
                                <div class="detail-row">
                                    <span>Tổng tiền:</span>
                                    <span class="text-primary"><strong>${Utils.formatCurrency(booking.tongTien)}</strong></span>
                                </div>
                                <div class="detail-row">
                                    <span>Trạng thái thanh toán:</span>
                                    <span class="status-badge pending">Chưa thanh toán</span>
                                </div>
                            </div>
                        </div>
                    `;

            Utils.showModal("#booking-detail-modal");
          } catch (error) {
            Utils.handleApiError(error);
          }
        }

        static updateStatus(bookingId) {
          const booking = window.adminBookings.bookings.find((b) => b.maDatPhong === bookingId);
          if (!booking) {
            Utils.showError("Không tìm thấy thông tin đặt phòng");
            return;
          }

          window.adminBookings.selectedBookingId = bookingId;
          Utils.$("#new-status").value = booking.trangThai;
          Utils.$("#status-note").value = "";
          Utils.showModal("#update-status-modal");
        }

        async saveStatusUpdate() {
          const newStatus = Utils.$("#new-status").value;
          const note = Utils.$("#status-note").value;

          if (!newStatus) {
            Utils.showError("Vui lòng chọn trạng thái mới");
            return;
          }

          const updateBtn = Utils.$("#update-status-btn");
          updateBtn.disabled = true;
          updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang cập nhật...';

          try {
            // Mock API call - replace with actual API
            await new Promise((resolve) => setTimeout(resolve, 1000));

            // Update local data
            const booking = this.bookings.find((b) => b.maDatPhong === this.selectedBookingId);
            if (booking) {
              booking.trangThai = newStatus;
            }

            Utils.showSuccess("Cập nhật trạng thái thành công");
            Utils.hideModal("#update-status-modal");
            this.calculateStats();
            this.renderBookingsTable();
            this.updateStatsCards();
          } catch (error) {
            Utils.handleApiError(error);
          } finally {
            updateBtn.disabled = false;
            updateBtn.innerHTML = '<i class="fas fa-save"></i> Cập nhật';
          }
        }

        static exportBookings() {
          // Mock export functionality
          Utils.showInfo("Chức năng xuất Excel đang được phát triển");
        }
      }

      // Initialize when page loads
      document.addEventListener("DOMContentLoaded", () => {
        if (Utils.requireAdmin()) {
          window.adminBookings = new AdminBookings();
        }
      });
    </script>

    <style>
      .booking-detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 2rem;
      }

      .detail-section {
        background: var(--bg-secondary);
        padding: 1.5rem;
        border-radius: var(--border-radius);
      }

      .detail-section h4 {
        margin-bottom: 1rem;
        color: var(--text-primary);
        font-size: 1.1rem;
        font-weight: 600;
      }

      .detail-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid var(--border-color);
      }

      .detail-row:last-child {
        border-bottom: none;
      }

      .detail-row span:first-child {
        color: var(--text-secondary);
        font-weight: 500;
      }

      .detail-row span:last-child {
        color: var(--text-primary);
        text-align: right;
      }
    </style>
  </body>
</html>
