<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Debug Room Type Functions</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  </head>
  <body>
    <div class="container mt-5">
      <h2>Debug Room Type Functions</h2>

      <div class="alert alert-info">
        <h5>Các bước kiểm tra:</h5>
        <ol>
          <li>Mở Developer Tools (F12)</li>
          <li>Vào tab Console</li>
          <li>Click các nút test bên dưới và xem kết quả trong console</li>
        </ol>
      </div>

      <div class="card mb-3">
        <div class="card-header">
          <h5>1. Test Backend Connection</h5>
        </div>
        <div class="card-body">
          <button class="btn btn-primary" onclick="testBackendConnection()">Test Backend</button>
          <div id="backendResult" class="mt-3"></div>
        </div>
      </div>

      <div class="card mb-3">
        <div class="card-header">
          <h5>2. Test Room Types Endpoint</h5>
        </div>
        <div class="card-body">
          <button class="btn btn-success" onclick="testRoomTypesEndpoint()">Test Room Types API</button>
          <div id="roomTypesResult" class="mt-3"></div>
        </div>
      </div>

      <div class="card mb-3">
        <div class="card-header">
          <h5>3. Test Add Room Type</h5>
        </div>
        <div class="card-body">
          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <input type="number" id="testHotelId" class="form-control" placeholder="Hotel ID (e.g., 1)" value="1" />
            </div>
            <div class="col-md-6">
              <input type="text" id="testRoomName" class="form-control" placeholder="Room Type Name" value="Test Room" />
            </div>
          </div>
          <button class="btn btn-warning" onclick="testAddRoomType()">Test Add Room Type</button>
          <div id="addResult" class="mt-3"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h5>4. Check Console Errors</h5>
        </div>
        <div class="card-body">
          <pre id="consoleErrors" class="bg-dark text-white p-3" style="max-height: 300px; overflow-y: auto"></pre>
        </div>
      </div>
    </div>

    <script>
      const API_URL = "http://localhost:5233/api";
      const consoleLog = [];

      // Override console.error to capture errors
      const originalError = console.error;
      console.error = function (...args) {
        consoleLog.push({ type: "error", message: args.join(" "), time: new Date().toLocaleTimeString() });
        updateConsoleDisplay();
        originalError.apply(console, args);
      };

      // Override console.log to capture logs
      const originalLog = console.log;
      console.log = function (...args) {
        consoleLog.push({ type: "log", message: args.join(" "), time: new Date().toLocaleTimeString() });
        updateConsoleDisplay();
        originalLog.apply(console, args);
      };

      function updateConsoleDisplay() {
        const display = document.getElementById("consoleErrors");
        display.innerHTML = consoleLog
          .map((log) => `<span class="${log.type === "error" ? "text-danger" : "text-success"}">[${log.time}] ${log.message}</span>`)
          .join("\n");
        display.scrollTop = display.scrollHeight;
      }

      function getAuthHeaders() {
        const token = localStorage.getItem("token");
        return {
          "Content-Type": "application/json",
          Authorization: token ? `Bearer ${token}` : "",
        };
      }

      async function testBackendConnection() {
        const resultDiv = document.getElementById("backendResult");
        resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Testing...';

        try {
          console.log("Testing backend connection...");
          const response = await fetch(`${API_URL}/hotels`, {
            headers: getAuthHeaders(),
          });

          console.log("Response status:", response.status);
          console.log("Response headers:", Object.fromEntries(response.headers.entries()));

          if (response.ok) {
            const data = await response.json();
            resultDiv.innerHTML = `<div class="alert alert-success">✅ Backend connected! Found ${
              data.length || data.data?.length || 0
            } hotels</div>`;
            console.log("Backend data:", data);
          } else {
            resultDiv.innerHTML = `<div class="alert alert-danger">❌ Backend error: ${response.status} ${response.statusText}</div>`;
          }
        } catch (error) {
          resultDiv.innerHTML = `<div class="alert alert-danger">❌ Connection failed: ${error.message}</div>`;
          console.error("Connection error:", error);
        }
      }

      async function testRoomTypesEndpoint() {
        const resultDiv = document.getElementById("roomTypesResult");
        resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Testing...';

        try {
          console.log("Testing room types endpoint...");
          const response = await fetch(`${API_URL}/roomtypes`, {
            headers: getAuthHeaders(),
          });

          console.log("Room types response status:", response.status);

          if (response.ok) {
            const data = await response.json();
            resultDiv.innerHTML = `<div class="alert alert-success">✅ Room Types API working! Found ${
              data.data?.length || data.length || 0
            } room types</div>`;
            console.log("Room types data:", data);
          } else {
            const errorText = await response.text();
            resultDiv.innerHTML = `<div class="alert alert-danger">❌ Room Types API error: ${response.status}<br>Details: ${errorText}</div>`;
            console.error("Room types error:", errorText);
          }
        } catch (error) {
          resultDiv.innerHTML = `<div class="alert alert-danger">❌ Request failed: ${error.message}</div>`;
          console.error("Room types request error:", error);
        }
      }

      async function testAddRoomType() {
        const resultDiv = document.getElementById("addResult");
        const hotelId = document.getElementById("testHotelId").value;
        const roomName = document.getElementById("testRoomName").value;

        if (!hotelId || !roomName) {
          resultDiv.innerHTML = '<div class="alert alert-warning">Please enter Hotel ID and Room Name</div>';
          return;
        }

        resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Testing...';

        const roomTypeData = {
          maKhachSan: parseInt(hotelId),
          tenLoaiPhong: roomName,
          giaMotDem: 500000,
          sucChua: 2,
          moTa: "Test room type",
        };

        try {
          console.log("Testing add room type with data:", roomTypeData);
          const response = await fetch(`${API_URL}/roomtypes`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              ...getAuthHeaders(),
            },
            body: JSON.stringify(roomTypeData),
          });

          console.log("Add room type response status:", response.status);
          const responseText = await response.text();
          console.log("Response text:", responseText);

          if (response.ok) {
            const data = JSON.parse(responseText);
            resultDiv.innerHTML = `<div class="alert alert-success">✅ Room type added successfully!<br>ID: ${data.data?.maLoaiPhong || "N/A"}</div>`;
          } else {
            resultDiv.innerHTML = `<div class="alert alert-danger">❌ Failed to add room type: ${response.status}<br>Details: ${responseText}</div>`;
          }
        } catch (error) {
          resultDiv.innerHTML = `<div class="alert alert-danger">❌ Request failed: ${error.message}</div>`;
          console.error("Add room type error:", error);
        }
      }

      // Test connection on load
      window.addEventListener("load", () => {
        console.log("Debug page loaded. API URL:", API_URL);
        console.log("Current auth token:", localStorage.getItem("token") ? "Present" : "Not found");
      });
    </script>
  </body>
</html>
