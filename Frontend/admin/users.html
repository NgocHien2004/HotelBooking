<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quản lý người dùng - Hotel Booking Admin</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <link href="../assets/css/style.css" rel="stylesheet" />
    <link href="../assets/css/admin.css" rel="stylesheet" />
  </head>
  <body>
    <!-- Header -->
    <header class="header">
      <nav class="navbar">
        <div class="nav-container">
          <div class="nav-logo">
            <a href="../index.html">
              <i class="fas fa-hotel"></i>
              <span>Hotel Booking Admin</span>
            </a>
          </div>

          <div class="nav-menu" id="nav-menu">
            <div class="nav-user" id="nav-user">
              <div class="user-dropdown">
                <button class="user-btn" id="user-btn">
                  <i class="fas fa-user"></i>
                  <span id="user-name">Admin</span>
                  <i class="fas fa-chevron-down"></i>
                </button>
                <div class="dropdown-menu" id="dropdown-menu">
                  <a href="../profile.html" class="dropdown-item"> <i class="fas fa-user"></i> Thông tin cá nhân </a>
                  <a href="../index.html" class="dropdown-item"> <i class="fas fa-home"></i> Trang chủ </a>
                  <hr />
                  <button class="dropdown-item logout-btn" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Đăng xuất</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <!-- Admin Layout -->
    <div class="admin-layout">
      <!-- Sidebar -->
      <aside class="admin-sidebar">
        <ul class="sidebar-menu">
          <li class="sidebar-item">
            <a href="dashboard.html" class="sidebar-link">
              <i class="fas fa-tachometer-alt"></i>
              <span>Dashboard</span>
            </a>
          </li>
          <li class="sidebar-item">
            <a href="hotels.html" class="sidebar-link">
              <i class="fas fa-hotel"></i>
              <span>Quản lý khách sạn</span>
            </a>
          </li>
          <li class="sidebar-item">
            <a href="rooms.html" class="sidebar-link">
              <i class="fas fa-bed"></i>
              <span>Quản lý phòng</span>
            </a>
          </li>
          <li class="sidebar-item">
            <a href="bookings.html" class="sidebar-link">
              <i class="fas fa-calendar-check"></i>
              <span>Quản lý đặt phòng</span>
            </a>
          </li>
          <li class="sidebar-item">
            <a href="users.html" class="sidebar-link active">
              <i class="fas fa-users"></i>
              <span>Quản lý người dùng</span>
            </a>
          </li>
          <li class="sidebar-item">
            <a href="reviews.html" class="sidebar-link">
              <i class="fas fa-star"></i>
              <span>Quản lý đánh giá</span>
            </a>
          </li>
        </ul>
      </aside>

      <!-- Main Content -->
      <main class="admin-content">
        <div class="admin-header">
          <h1>Quản lý người dùng</h1>
          <p>Quản lý tài khoản và phân quyền người dùng</p>
        </div>

        <!-- Stats Cards -->
        <div class="admin-cards">
          <div class="admin-card">
            <div class="admin-card-header">
              <h3 class="admin-card-title">Tổng người dùng</h3>
              <div class="admin-card-icon">
                <i class="fas fa-users"></i>
              </div>
            </div>
            <div class="admin-card-value" id="total-users">0</div>
          </div>

          <div class="admin-card">
            <div class="admin-card-header">
              <h3 class="admin-card-title">Khách hàng</h3>
              <div class="admin-card-icon">
                <i class="fas fa-user"></i>
              </div>
            </div>
            <div class="admin-card-value" id="customer-count">0</div>
          </div>

          <div class="admin-card">
            <div class="admin-card-header">
              <h3 class="admin-card-title">Admin</h3>
              <div class="admin-card-icon">
                <i class="fas fa-user-shield"></i>
              </div>
            </div>
            <div class="admin-card-value" id="admin-count">0</div>
          </div>

          <div class="admin-card">
            <div class="admin-card-header">
              <h3 class="admin-card-title">Người dùng mới</h3>
              <div class="admin-card-icon">
                <i class="fas fa-user-plus"></i>
              </div>
            </div>
            <div class="admin-card-value" id="new-users-today">0</div>
          </div>
        </div>

        <!-- Users Table -->
        <div class="admin-table-container">
          <div class="admin-table-header">
            <h3 class="admin-table-title">Danh sách người dùng</h3>
            <div class="admin-table-actions">
              <select id="role-filter" class="search-input">
                <option value="">Tất cả vai trò</option>
                <option value="Customer">Khách hàng</option>
                <option value="Admin">Admin</option>
              </select>
              <input type="text" class="search-input" id="search-users" placeholder="Tìm kiếm người dùng..." />
              <button class="btn btn-primary" onclick="AdminUsersPage.showAddUserModal()">
                <i class="fas fa-user-plus"></i>
                Thêm người dùng
              </button>
            </div>
          </div>

          <div class="loading" id="users-loading">
            <div class="spinner"></div>
            <p>Đang tải dữ liệu...</p>
          </div>

          <table class="admin-table" id="users-table" style="display: none">
            <thead>
              <tr>
                <th>ID</th>
                <th>Thông tin</th>
                <th>Vai trò</th>
                <th>Ngày tạo</th>
                <th>Trạng thái</th>
                <th>Thao tác</th>
              </tr>
            </thead>
            <tbody id="users-table-body">
              <!-- Users will be loaded here -->
            </tbody>
          </table>

          <!-- Pagination -->
          <div class="pagination" id="users-pagination">
            <!-- Pagination will be loaded here -->
          </div>
        </div>
      </main>
    </div>

    <!-- Add/Edit User Modal -->
    <div class="modal admin-modal" id="user-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title" id="user-modal-title">Thêm người dùng mới</h3>
          <button class="modal-close" onclick="Utils.hideModal('#user-modal')">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <form id="user-form" class="admin-form">
            <input type="hidden" id="user-id" name="id" />

            <div class="form-row">
              <div class="form-group">
                <label for="user-name" class="form-label">Họ và tên *</label>
                <input type="text" id="user-name" name="hoTen" class="form-input" required />
              </div>
              <div class="form-group">
                <label for="user-email" class="form-label">Email *</label>
                <input type="email" id="user-email" name="email" class="form-input" required />
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="user-phone" class="form-label">Số điện thoại</label>
                <input type="tel" id="user-phone" name="soDienThoai" class="form-input" />
              </div>
              <div class="form-group">
                <label for="user-role" class="form-label">Vai trò *</label>
                <select id="user-role" name="vaiTro" class="form-input" required>
                  <option value="Customer">Khách hàng</option>
                  <option value="Admin">Admin</option>
                </select>
              </div>
            </div>

            <div class="form-group" id="password-group">
              <label for="user-password" class="form-label">Mật khẩu *</label>
              <input type="password" id="user-password" name="matKhau" class="form-input" required />
              <small class="text-secondary">Tối thiểu 6 ký tự</small>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="Utils.hideModal('#user-modal')">Hủy</button>
          <button type="submit" form="user-form" class="btn btn-primary" id="user-save-btn">
            <i class="fas fa-save"></i>
            Lưu
          </button>
        </div>
      </div>
    </div>

    <!-- Change Role Modal -->
    <div class="modal" id="change-role-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Thay đổi vai trò</h3>
          <button class="modal-close" onclick="Utils.hideModal('#change-role-modal')">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <p id="change-role-message">Bạn có chắc chắn muốn thay đổi vai trò của người dùng này?</p>
          <div class="form-group">
            <label for="new-role">Vai trò mới:</label>
            <select id="new-role" class="form-input">
              <option value="Customer">Khách hàng</option>
              <option value="Admin">Admin</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="Utils.hideModal('#change-role-modal')">Hủy</button>
          <button type="button" class="btn btn-primary" id="confirm-role-change">
            <i class="fas fa-save"></i>
            Thay đổi
          </button>
        </div>
      </div>
    </div>

    <!-- Delete User Modal -->
    <div class="modal" id="delete-user-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Xác nhận xóa</h3>
          <button class="modal-close" onclick="Utils.hideModal('#delete-user-modal')">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <p>Bạn có chắc chắn muốn xóa người dùng này?</p>
          <p class="text-error">Hành động này không thể hoàn tác!</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="Utils.hideModal('#delete-user-modal')">Hủy</button>
          <button type="button" class="btn btn-error" id="confirm-delete-user">
            <i class="fas fa-trash"></i>
            Xóa
          </button>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="../assets/js/utils.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/admin.js"></script>
    <script src="../assets/js/app.js"></script>

    <script>
      // Admin Users Page
      class AdminUsersPage {
        constructor() {
          this.users = [];
          this.currentPage = 1;
          this.totalPages = 1;
          this.selectedUserId = null;
          this.stats = {
            total: 0,
            customers: 0,
            admins: 0,
            newToday: 0,
          };

          this.init();
        }

        async init() {
          await this.loadUsers();
          this.bindEvents();
        }

        async loadUsers() {
          try {
            Utils.show("#users-loading");
            Utils.hide("#users-table");

            // Mock data - replace with actual API call
            this.users = [
              {
                maNguoiDung: 1,
                hoTen: "Nguyễn Văn A",
                email: "nguyenvana@email.com",
                soDienThoai: "0123456789",
                vaiTro: "Customer",
                ngayTao: "2024-01-15T10:30:00",
                trangThai: "Active",
              },
              {
                maNguoiDung: 2,
                hoTen: "Trần Thị B",
                email: "tranthib@email.com",
                soDienThoai: "0987654321",
                vaiTro: "Customer",
                ngayTao: "2024-02-20T14:15:00",
                trangThai: "Active",
              },
              {
                maNguoiDung: 3,
                hoTen: "Admin User",
                email: "admin@hotel.com",
                soDienThoai: "0111222333",
                vaiTro: "Admin",
                ngayTao: "2024-01-01T09:00:00",
                trangThai: "Active",
              },
              {
                maNguoiDung: 4,
                hoTen: "Lê Văn C",
                email: "levanc@email.com",
                soDienThoai: "0555666777",
                vaiTro: "Customer",
                ngayTao: "2024-12-25T16:20:00",
                trangThai: "Active",
              },
            ];

            this.calculateStats();
            this.renderUsersTable();
            this.updateStatsCards();
          } catch (error) {
            Utils.handleApiError(error);
          } finally {
            Utils.hide("#users-loading");
            Utils.show("#users-table");
          }
        }

        calculateStats() {
          this.stats.total = this.users.length;
          this.stats.customers = this.users.filter((u) => u.vaiTro === "Customer").length;
          this.stats.admins = this.users.filter((u) => u.vaiTro === "Admin").length;

          // Calculate new users today
          const today = new Date().toISOString().split("T")[0];
          this.stats.newToday = this.users.filter((u) => u.ngayTao.startsWith(today)).length;
        }

        updateStatsCards() {
          Utils.$("#total-users").textContent = this.stats.total;
          Utils.$("#customer-count").textContent = this.stats.customers;
          Utils.$("#admin-count").textContent = this.stats.admins;
          Utils.$("#new-users-today").textContent = this.stats.newToday;
        }

        renderUsersTable() {
          const tbody = Utils.$("#users-table-body");
          if (!tbody) return;

          if (this.users.length === 0) {
            tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center">
                                Chưa có người dùng nào
                            </td>
                        </tr>
                    `;
            return;
          }

          tbody.innerHTML = this.users
            .map(
              (user) => `
                    <tr>
                        <td>#${user.maNguoiDung}</td>
                        <td>
                            <div class="user-info">
                                <div class="user-avatar">
                                    <i class="fas fa-user-circle"></i>
                                </div>
                                <div class="user-details">
                                    <strong>${user.hoTen}</strong>
                                    <br>
                                    <small class="text-secondary">${user.email}</small>
                                    ${user.soDienThoai ? `<br><small class="text-secondary">${user.soDienThoai}</small>` : ""}
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="status-badge ${user.vaiTro.toLowerCase()}">
                                ${user.vaiTro === "Admin" ? "Quản trị viên" : "Khách hàng"}
                            </span>
                        </td>
                        <td>${Utils.formatDate(user.ngayTao)}</td>
                        <td>
                            <span class="status-badge ${user.trangThai.toLowerCase()}">
                                ${user.trangThai === "Active" ? "Hoạt động" : "Không hoạt động"}
                            </span>
                        </td>
                        <td class="actions">
                            <button class="btn btn-sm btn-outline" onclick="AdminUsersPage.editUser(${user.maNguoiDung})" title="Sửa">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="AdminUsersPage.changeRole(${user.maNguoiDung})" title="Đổi vai trò">
                                <i class="fas fa-user-cog"></i>
                            </button>
                            ${
                              user.vaiTro !== "Admin" || this.stats.admins > 1
                                ? `
                                <button class="btn btn-sm btn-error" onclick="AdminUsersPage.deleteUser(${user.maNguoiDung})" title="Xóa">
                                    <i class="fas fa-trash"></i>
                                </button>
                            `
                                : ""
                            }
                        </td>
                    </tr>
                `
            )
            .join("");
        }

        bindEvents() {
          // Filter events
          const roleFilter = Utils.$("#role-filter");
          const searchInput = Utils.$("#search-users");

          if (roleFilter) {
            roleFilter.addEventListener("change", () => {
              this.applyFilters();
            });
          }

          if (searchInput) {
            searchInput.addEventListener(
              "input",
              Utils.debounce(() => {
                this.applyFilters();
              }, 300)
            );
          }

          // Form events
          const userForm = Utils.$("#user-form");
          if (userForm) {
            userForm.addEventListener("submit", (e) => {
              e.preventDefault();
              this.saveUser();
            });
          }

          // Role change confirmation
          const confirmRoleChange = Utils.$("#confirm-role-change");
          if (confirmRoleChange) {
            confirmRoleChange.addEventListener("click", () => {
              this.confirmRoleChange();
            });
          }

          // Delete confirmation
          const confirmDeleteUser = Utils.$("#confirm-delete-user");
          if (confirmDeleteUser) {
            confirmDeleteUser.addEventListener("click", () => {
              this.confirmDeleteUser();
            });
          }
        }

        applyFilters() {
          const roleFilter = Utils.$("#role-filter").value;
          const searchTerm = Utils.$("#search-users").value.toLowerCase();

          let filteredUsers = [...this.users];

          // Filter by role
          if (roleFilter) {
            filteredUsers = filteredUsers.filter((user) => user.vaiTro === roleFilter);
          }

          // Filter by search term
          if (searchTerm) {
            filteredUsers = filteredUsers.filter(
              (user) =>
                user.hoTen.toLowerCase().includes(searchTerm) ||
                user.email.toLowerCase().includes(searchTerm) ||
                (user.soDienThoai && user.soDienThoai.includes(searchTerm))
            );
          }

          this.renderFilteredUsersTable(filteredUsers);
        }

        renderFilteredUsersTable(users) {
          const tbody = Utils.$("#users-table-body");
          if (!tbody) return;

          if (users.length === 0) {
            tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center">
                                Không tìm thấy người dùng nào phù hợp
                            </td>
                        </tr>
                    `;
            return;
          }

          tbody.innerHTML = users
            .map(
              (user) => `
                    <tr>
                        <td>#${user.maNguoiDung}</td>
                        <td>
                            <div class="user-info">
                                <div class="user-avatar">
                                    <i class="fas fa-user-circle"></i>
                                </div>
                                <div class="user-details">
                                    <strong>${user.hoTen}</strong>
                                    <br>
                                    <small class="text-secondary">${user.email}</small>
                                    ${user.soDienThoai ? `<br><small class="text-secondary">${user.soDienThoai}</small>` : ""}
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="status-badge ${user.vaiTro.toLowerCase()}">
                                ${user.vaiTro === "Admin" ? "Quản trị viên" : "Khách hàng"}
                            </span>
                        </td>
                        <td>${Utils.formatDate(user.ngayTao)}</td>
                        <td>
                            <span class="status-badge ${user.trangThai.toLowerCase()}">
                                ${user.trangThai === "Active" ? "Hoạt động" : "Không hoạt động"}
                            </span>
                        </td>
                        <td class="actions">
                            <button class="btn btn-sm btn-outline" onclick="AdminUsersPage.editUser(${user.maNguoiDung})" title="Sửa">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="AdminUsersPage.changeRole(${user.maNguoiDung})" title="Đổi vai trò">
                                <i class="fas fa-user-cog"></i>
                            </button>
                            ${
                              user.vaiTro !== "Admin" || window.adminUsersPage.stats.admins > 1
                                ? `
                                <button class="btn btn-sm btn-error" onclick="AdminUsersPage.deleteUser(${user.maNguoiDung})" title="Xóa">
                                    <i class="fas fa-trash"></i>
                                </button>
                            `
                                : ""
                            }
                        </td>
                    </tr>
                `
            )
            .join("");
        }

        // Static methods for UI actions
        static showAddUserModal() {
          Utils.$("#user-modal-title").textContent = "Thêm người dùng mới";
          Utils.$("#user-save-btn").innerHTML = '<i class="fas fa-save"></i> Lưu';
          Utils.clearForm("#user-form");
          Utils.show("#password-group");
          Utils.$("#user-password").required = true;
          Utils.showModal("#user-modal");
        }

        static editUser(userId) {
          const user = window.adminUsersPage.users.find((u) => u.maNguoiDung === userId);
          if (!user) {
            Utils.showError("Không tìm thấy thông tin người dùng");
            return;
          }

          Utils.$("#user-modal-title").textContent = "Sửa thông tin người dùng";
          Utils.$("#user-save-btn").innerHTML = '<i class="fas fa-save"></i> Cập nhật';

          // Fill form data
          Utils.$("#user-id").value = user.maNguoiDung;
          Utils.$("#user-name").value = user.hoTen;
          Utils.$("#user-email").value = user.email;
          Utils.$("#user-phone").value = user.soDienThoai || "";
          Utils.$("#user-role").value = user.vaiTro;

          // Hide password field for edit
          Utils.hide("#password-group");
          Utils.$("#user-password").required = false;

          Utils.showModal("#user-modal");
        }

        static changeRole(userId) {
          const user = window.adminUsersPage.users.find((u) => u.maNguoiDung === userId);
          if (!user) {
            Utils.showError("Không tìm thấy thông tin người dùng");
            return;
          }

          window.adminUsersPage.selectedUserId = userId;
          Utils.$("#change-role-message").textContent = `Thay đổi vai trò của ${user.hoTen} (${user.email})?`;
          Utils.$("#new-role").value = user.vaiTro === "Admin" ? "Customer" : "Admin";
          Utils.showModal("#change-role-modal");
        }

        static deleteUser(userId) {
          const user = window.adminUsersPage.users.find((u) => u.maNguoiDung === userId);
          if (!user) {
            Utils.showError("Không tìm thấy thông tin người dùng");
            return;
          }

          // Prevent deleting the last admin
          if (user.vaiTro === "Admin" && window.adminUsersPage.stats.admins <= 1) {
            Utils.showError("Không thể xóa admin cuối cùng trong hệ thống");
            return;
          }

          window.adminUsersPage.selectedUserId = userId;
          Utils.showModal("#delete-user-modal");
        }

        async saveUser() {
          const formData = Utils.getFormData("#user-form");
          const userId = formData.id;

          // Validate form
          if (!formData.hoTen.trim()) {
            Utils.showError("Vui lòng nhập họ tên");
            return;
          }

          if (!formData.email.trim() || !Utils.validateEmail(formData.email)) {
            Utils.showError("Vui lòng nhập email hợp lệ");
            return;
          }

          if (!userId && (!formData.matKhau || !Utils.validatePassword(formData.matKhau))) {
            Utils.showError("Mật khẩu phải có ít nhất 6 ký tự");
            return;
          }

          const saveBtn = Utils.$("#user-save-btn");
          saveBtn.disabled = true;
          saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang lưu...';

          try {
            // Mock save - replace with actual API call
            await new Promise((resolve) => setTimeout(resolve, 1000));

            Utils.showSuccess(userId ? "Cập nhật người dùng thành công" : "Thêm người dùng thành công");
            Utils.hideModal("#user-modal");
            await this.loadUsers();
          } catch (error) {
            Utils.handleApiError(error);
          } finally {
            saveBtn.disabled = false;
            saveBtn.innerHTML = userId ? '<i class="fas fa-save"></i> Cập nhật' : '<i class="fas fa-save"></i> Lưu';
          }
        }

        async confirmRoleChange() {
          const newRole = Utils.$("#new-role").value;

          try {
            // Mock API call
            await new Promise((resolve) => setTimeout(resolve, 500));

            const user = this.users.find((u) => u.maNguoiDung === this.selectedUserId);
            if (user) {
              user.vaiTro = newRole;
              this.calculateStats();
              this.updateStatsCards();
              Utils.showSuccess("Thay đổi vai trò thành công");
            }
            Utils.hideModal("#change-role-modal");
          } catch (error) {
            Utils.handleApiError(error);
          }
        }

        async confirmDeleteUser() {
          try {
            // Mock API call
            await new Promise((resolve) => setTimeout(resolve, 500));

            const index = this.users.findIndex((u) => u.maNguoiDung === this.selectedUserId);
            if (index !== -1) {
              this.users.splice(index, 1);
              this.calculateStats();
              this.renderUsersTable();
              this.updateStatsCards();
              Utils.showSuccess("Xóa người dùng thành công");
            }
            Utils.hideModal("#delete-user-modal");
          } catch (error) {
            Utils.handleApiError(error);
          }
        }
      }

      // Initialize when page loads
      document.addEventListener("DOMContentLoaded", () => {
        if (Utils.requireAdmin()) {
          window.adminUsersPage = new AdminUsersPage();
        }
      });
    </script>

    <style>
      .user-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .user-avatar {
        font-size: 2rem;
        color: var(--text-secondary);
      }

      .user-details {
        line-height: 1.4;
      }

      .status-badge.customer {
        background-color: #dbeafe;
        color: #1e40af;
      }

      .status-badge.admin {
        background-color: #fef3c7;
        color: #92400e;
      }

      .status-badge.active {
        background-color: #dcfce7;
        color: #166534;
      }

      #password-group small {
        display: block;
        margin-top: 0.25rem;
      }
    </style>
  </body>
</html>
